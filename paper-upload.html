<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../paper-input/paper-input-container.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-file-icons/file-icons.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<!--
https://github.com/IswPolymerElements/isw-filetype-icon/blob/master/isw-filetype-icon.html
This one seems nicer
-->

<dom-module id="paper-upload">
    <template>
        <style>
            #fileInput {
                height: 0;
                width: 0;
                outline: 0;
                border: 0;
                overflow: hidden;
            }

            label {
            }
            .container{
                color: #333333;
                background: #E7E7E7;
                padding: 0 0.3em 0 0.2em;
                margin: 0.1em 0.2em 0.15em 0;
                vertical-align: middle;
                cursor: pointer;
                border-radius: 0.7em;
                /*overflow: hidden;*/
                white-space: nowrap;
                max-width: 100%;
                display: flex;
                align-items: center;
            }
            .container>span{
                /*vertical-align: middle;*/
            }
            .closeBtn{
                flex-shrink: 0;
                width: 16px;
                height: 16px;
                margin-left: 3px;
            }
            .fileSize{
                color: #505050;
                flex-shrink: 0;
            }
            .fileExtension{
                flex-shrink: 0;
            }
            .fileName{
                flex: 1;
                flex-basis: 1px;
                text-overflow: ellipsis;
                overflow: hidden;
            }
            .fileIcon{
                flex-shrink: 0;
            }
        </style>
        <input id="fileInput" hidden multiple$="[[multiple]]" name="[[name]]" type="file" on-change="displayFile"/>
        <label for="fileInput">
            <paper-input-container always-float-label>
                <label for="fileInput" slot="label">[[label]]</label>
                <div slot="input" style="position:relative;min-height:24px;display:flex;flex-direction: column;">
                    <input type="hidden" />
                    <div style="flex:1;display: flex;flex-wrap: wrap;">
                        <template is="dom-repeat" items="[[value]]">
                            <span class="container" on-click="preventDefault">
                                <iron-icon class="fileIcon" icon="[[getIcon(item.type)]]"></iron-icon>
                                <span class="fileName">[[noExtension(item.name)]]</span>
                                <span class="fileExtension">[[extension(item.name)]]</span>
                                <span class="fileSize" >([[formatSize(item.size)]])</span>
                                <iron-icon class="closeBtn" icon="icons:backspace" on-click="remove"></iron-icon>
                            </span>
                        </template>
                    </div>
                </div>
            </paper-input-container>
        </label>
    </template>

    <script>
        /**
         * `paper-upload`
         *
         *
         * @customElement
         * @polymer
         * @demo demo/index.html
         */
        class PaperUpload extends Polymer.Element {
            static get is() {
                return 'paper-upload';
            }

            static get properties() {
                return {
                    label: {
                        type: String,
                        value: 'Upload file'
                    },
                    name: {
                        type: String,
                        value: 'upload'
                    },
                    value: {
                        type: Array,
                        value: function () {
                            return [];
                        },
                        observer:"valueChanged"
                    },
                    required:{
                        type:Boolean,
                        value:false
                    },
                    multiple:{
                        type:Boolean,
                        value:false
                    }
                };
            }

            valueChanged(newValue){
                if(typeof this.value === 'string'){
                    if(this.value !== "") {
                        this.value = [this.value];
                    }else if(this.value === ""){
                        this.value = [];
                    }
                } else {
                    for(let i=0; i< this.value.length; i++){
                        if(typeof this.value[i] === 'string'){
                            this.set("value." + i, JSON.parse(this.value[i]));
                        }
                    }
                    this.dispatchEvent(new CustomEvent("selected-changed", {
                        bubbles: true,
                        composed: true,
                        detail: {
                            value: this.value
                        }
                    }));
                }
            }


            displayFile(event) {
                let input = event.path[0];
                //this.value = input.files[0];
                if (this.multiple) {
                    for (let i = 0; i < input.files.length; i++) {
                        this.push("value", {
                            name: input.files.item(i).name,
                            size: input.files.item(i).size,
                            type: input.files.item(i).type,
                            file: input.files[i],
                            blobKey: undefined
                        });
                    }
                } else {
                    this.value = [{
                        name: input.files.item(0).name,
                        size: input.files.item(0).size,
                        type: input.files.item(0).type,
                        file: input.files[0],
                        blobKey: undefined
                    }]
                }
                input.value = null;
                this.dispatchEvent(new CustomEvent("value-changed", {
                    bubbles: true,
                    composed: true,
                    detail: {
                        value: this.value
                    }
                }));
            }

            formatSize(value) {
                if (value < 1024) {
                    return value + "B"
                } else if (value / 1024 < 1024) {
                    return parseInt(value / 1024) + "KB"
                } else if (value / (1024 * 1024) < 1024) {
                    return parseInt(value / (1024 * 1024)) + "MB"
                } else if (value / (1024 * 1024 * 1024) < 1024) {
                    return parseInt(value / (1024 * 1024 * 1024)) + "GB"
                } else if (value / (1024 * 1024 * 1024 * 1024) < 1024) {
                    return parseInt(value / (1024 * 1024 * 1024 * 1024)) + "TB"
                } else {
                    return parseInt(value / (1024 * 1024 * 1024 * 1024 * 1024)) + "PB"
                }
            }

            getIcon(type) {
                if(type === undefined){
                    return "file:generic"
                } else if (type.indexOf("video/") >= 0) {
                    return "file:video"
                } else if (type.indexOf("audio/") >= 0) {
                    return "file:audio"
                } else if (type.indexOf("image/") >= 0) {
                    return "file:image"
                } else if (type === "application/pdf") {
                    return "file:pdf"
                } else if (type === "application/vnd.ms-excel" || type === "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet") {
                    return "file:excel"
                } else {
                    return "file:generic"
                }
                //
                //application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
            }
            validate(){
                return (!this.required || this.value.length>0);
            }
            noExtension(name){
                let extensionPos=name.lastIndexOf(".");
                if(extensionPos>=0 && name.length>8) {
                    return name.substr(0, name.length - 8);
                }else{
                    return name;
                }
            }
            extension(name){
                let extensionPos=name.lastIndexOf(".");
                if(extensionPos>=0 && name.length>8) {
                    return name.substr(name.length -8);
                }else{
                    return "";
                }
            }
            remove(event){
                console.log(event.model.index,event.model.item);
                this.splice("value", event.model.index,1);
                event.stopPropagation();
                event.preventDefault();
            }
            preventDefault(event){
                event.stopPropagation();
                event.preventDefault();
            }
        }

        window.customElements.define(PaperUpload.is, PaperUpload);
    </script>
</dom-module>
